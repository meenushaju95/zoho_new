{% extends 'base.html' %}
{% block content %}
{% load static %}
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
<!-- Include jQuery -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-...your-integrity-code-here..." crossorigin="anonymous" />


<script src="https://cdnjs.cloudflare.com/ajax/libs/openpyxl/3.0.9/openpyxl.min.js"></script>

<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.css">
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.js"></script>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://kit.fontawesome.com/274ee977b7.js" crossorigin="anonymous"></script>

<style>
    .clickable-row {
        cursor: pointer;
    }
    .orange-link {
        display: inline-block;
        padding: 10px;
        text-decoration: none;
        color: orange;
        
        border: 2px solid orange;
        border-radius: 5px;
        transition: background-color 0.3s, color 0.3s;
        margin-left: 10px;
       
    }

    .orange-link:hover {
        background-color: orange;
        color: white;
    }

    .search-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .search-input {
        padding: 5px;
        border: 1px solid white;
        border-radius: 5px;
        font-size: 16px;
        color: white;
        flex-grow: 1; 
    }

    .search-icon {
        background: none;
        border: none;
        cursor: pointer;
        padding: 5px;
    }
    .dropdown-menu .dropdown-item:hover {
    background-color: transparent; 
}
</style>

<body>
    <div class="body-wrapper">
        <div class="container-fluid">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'company_dashboard' %}" class="text-warning-emphasis">Dashboard</a></li>
                    <li class="breadcrumb-item"  aria-current="page"><a href="" >All Delivery Challan</a> </li>
                </ol>
            </nav>
            <div class="container-fluid bg-black p-3">
                <h4  style="color: white;margin-top: 20px;">All Delivery Challan</h4>

               
                {% for message in messages %}
                <h5>
                  <div class="alert alert-danger message text-center" style="color: black;" id="alert_danger">
                    {{ message }}
                    <a type="button" id="alert_close" class="close" data-dismiss="alert" aria-label="Close" style="float: right;">
                      <span aria-hidden="true" style="font-size: large; color: #68020F;">&times;</span>
                    </a>
                  </div>
                </h5>
                {% endfor %}

                <div class="row">
                    <div class="col-md-3">
                        
                        <div class="input-group mt-5">
                            <input type="text" id="searchInput" style="background-color: white;color: black;" class="form-control" placeholder=" Search here.." >
                            
                        </div>
                    </div>
                    <div class="col-md-5">
                        <!-- Your dropdown menu goes here -->
                        <div class="btn-group">
                            <button type="button" class="btn orange-link mt-5 dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <i class="fa fa-sort" aria-hidden="true"></i>
                            </button>
                            <div class="dropdown-menu dropdown-menu-right" style="background-color: black;color: white;">
                              <button class="dropdown-item" type="button" id="sortAll" style="color: white;">All</button>
                              <button class="dropdown-item" type="button" id="sortName" style="color: white;">Customer Name</button>
                              <button class="dropdown-item" type="button" id="sortNo" style="color: white;">DC NO</button>
                            </div>
                          </div>
                    </div>
                    
                   
                    <div class="col-md-4">
                        
                        
                        
                       
                        <div class="d-flex justify-content-end ">
                            <div class="btn-group">
                                <button type="button" class="btn orange-link mt-5 dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="fa fa-filter" aria-hidden="true"></i>
                                </button>
                                <div class="dropdown-menu dropdown-menu-right" style="background-color: black;color: white;">
                                  <button class="dropdown-item" type="button" id="filterAll" style="color: white;">All</button>
                                  <button class="dropdown-item" type="button" id="filterDraft" style="color: white;">Draft</button>
                                  <button class="dropdown-item" type="button" id="filterSave" style="color: white;">Save</button>
                                </div>
                              </div>
                        <a href="#" class="orange-link mt-5 "  id="importExcel" data-toggle="modal" data-target="#importModal" onclick="excelmodel()"><i class="fa fa-share-square-o" aria-hidden="true"></i> Import</a>
                        
                        <a href="#" class="orange-link mt-5 " onclick="exportToExcel()"  id="ExportExcel"><i class="fa fa-share-square-o" aria-hidden="true"></i> Export</a>
                        <a href="{% url 'delivery_challan' %}"class="orange-link mt-5">New+</a>
                          
                    </div>
                </form>
                </div>
               
                 

               <!-- Import Estimate modal -->
<div class="modal fade" id="importModal">
    <div class="modal-dialog modal-xl">
        <div class="modal-content" style="background-color: #3b3b3b;">
            <div class="modal-header">
                <h3 class="modal-title text-light" id="exampleModalLabel">Delivery Challan</h3>
                <button type="button" class="btn close text-white" data-bs-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true" style="font-size: x-large;">&times;</span>
                </button>
              </div>
            <div class="modal-body mx-3 rounded-1" style="background-color: #000;">
                <div class="file_instructions">
                    <div class="alert alert-danger" role="alert">
                        <span class="fw-bolder">IMPORTANT:</span>
                        <p>File should have 2 sheets named 'delivery_challan' & 'items' and column name & order should be in the given formate(Uppercase).</p>
                        <p class="fw-bolder">Delivery Challan sheet - SLNO*, CUSTOMER*,CUSTOMER EMAIL*, DATE*, PLACE OF SUPPLY*,  DC NO*, DESCRIPTION, SUB TOTAL*, IGST*, CGST*, SGST*, TAX AMOUNT*, ADJUSTMENT, SHIPPING CHARGE, GRAND TOTAL*, ADVANCE </p>
                        <p class="fw-bolder">Items sheet - DC NO**, PRODUCT*, HSN*, QUANTITY*, PRICE*, TAX PERCENTAGE*, DISCOUNT, TOTAL* </p>
                        <p>* All required columns should be filled.</p>
                       
                        <p>Place of supply should be in the give format with state code('Ex: [KL]-Kerala') or '[OT]-Other Territory'.</p>
                        <p>Date format should be 'YYYY-MM-DD' or 'DD-MM-YYYY'.</p>
                    </div>
                </div>
                <div class="sample_file mb-2">
                    <a href="{% url 'downloadDeliveryChallanSampleImportFile' %}" class="fw-bolder btn btn-outline-warning btn-sm">Download Sample File</a>
                </div>
                <form id="importEstimateForm" action="{% url 'importDeliveryChallanFromExcel' %}" method="POST" class="form" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="excel_file" class="form-label text-white">File</label>
                        <input id="excel_file" class="form-control" type="file" name="excel_file" required>
                    </div>
                    <div class="d-flex justify-content-center mt-4">
                        <input id="submit_import_excel" value="IMPORT" class="btn btn-outline-warning" type="submit">
                    </div>
                    
                </form>
            </div>
            <div class="modal-footer"></div>
        </div>
    </div>
</div>

              
            

            <div class="table-responsive">
                <table id="attendanceTable" class="table mt-lg-5 mt-2 rounded " style="background-color: rgb(0, 0, 0);color: white;text-align: center;">
                    <thead>
                        <tr class="border-bottom border-dark">
                            <th scope="col"><b>#</b></th>
                            <th scope="col"><b>Date</b></th>
                            <th scope="col"><b>Challan Number</b></th>
                            <th scope="col"><b>Customer Name</b></th>
                            <th scope="col"><b>Customer Mail ID</b></th>
                            <th scope="col"><b>Amount</b></th>
                            <th scope="col"><b>Status</b></th>
                            <th scope="col"><b>Balance</b></th>
                            <th scope="col"><b>Action</b></th>
                        </tr>
                    </thead>
                    <tbody>
                        
                        {% for dc in d_challan %}
                        <tr class="border-bottom border-dark clickable-row" data-href="{% url 'challan_overview' dc.id %}">
                            <td>{{forloop.counter}}</td>
                            <td>{{dc.challan_date}}</td>
                            <td>{{dc.challan_number}}</td>
                            <td>{{dc.customer.first_name}} {{dc.customer.last_name}}</td>
                            <td>{{dc.customer.customer_email}}</td>
                            <td>{{dc.grand_total}}</td> 
                            <td>{{dc.status}}</td> 
                            <td>{{dc.balance}}</td> 
                            <td>
                                <div class="dropdown" >
                                    <a class="btn orange-link" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false" role="button">
                                        Convert
                                    </a>
                                    <div class="dropdown-menu m-1" style="background-color: black; color: white;">
                                        <a class="dropdown-item dropdown-item-filter" href="" style="background-color: black; color: white;">Invoice</a>
                                        <a class="dropdown-item dropdown-item-filter" href="{% url 'convert_rec_invoice' dc.id %}" style="background-color: black; color: white;">Recurring Invoice</a>
                                    </div>
                                </div>
                            </td>
                        </tr>
                            {% endfor %}
                        
                        
                      

                        

                    </tbody>
                </table>
                
               


            </div>
            </div>
        </div>
    </div>

    <script>
        
        function stopDropdownItemClickPropagation() {
            document.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', function (e) {
                    e.stopPropagation();
                });
            });
        }
    
        
        function excludeLastTDFromClick() {
            document.querySelectorAll('.clickable-row td:last-child').forEach(td => {
                td.addEventListener('click', function (e) {
                    e.stopPropagation();
                });
            });
        }
    
        
        document.addEventListener('DOMContentLoaded', function() {
            stopDropdownItemClickPropagation();
            excludeLastTDFromClick();
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var rows = document.querySelectorAll(".clickable-row");
    
            document.getElementById("searchInput").addEventListener("input", function() {
                var searchValue = this.value.toLowerCase();
    
                rows.forEach(function(row) {
                    var rowText = row.textContent.toLowerCase();
                    row.style.display = rowText.includes(searchValue) ? "" : "none";
                });
            });
    
            rows.forEach(function(row) {
                row.addEventListener("click", function() {
                    var href = this.getAttribute("data-href");
                    if (href) {
                        window.location.href = href;
                    }
                });
            });
        });
    </script>



<script>
    document.addEventListener('DOMContentLoaded', function () {
   
    document.querySelectorAll('.clickable-row').forEach(row => {
        row.addEventListener('click', () => {
            
            console.log('Row clicked');
        });
    });

    
    function sortTable(columnIndex, isNumeric) {
        const tbody = document.querySelector('#attendanceTable tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));

        rows.sort((a, b) => {
            const aValue = isNumeric ? parseFloat(a.cells[columnIndex].textContent.trim()) : a.cells[columnIndex].textContent.trim();
            const bValue = isNumeric ? parseFloat(b.cells[columnIndex].textContent.trim()) : b.cells[columnIndex].textContent.trim();
            return aValue.localeCompare(bValue, undefined, { numeric: isNumeric });
        });

        
        tbody.innerHTML = '';
        rows.forEach(row => {
            tbody.appendChild(row);
        });
    }

   
    document.getElementById('sortName').addEventListener('click', function () {
        sortTable(3, false); // Sort by customer name (column index 3), assuming it's the 4th column
    });

    
    document.getElementById('sortNo').addEventListener('click', function () {
        sortTable(2, false); // Sort by Challan Number (column index 2), assuming it's the 3rd column
    });

    
    document.getElementById('sortAll').addEventListener('click', function () {
        
        location.reload();
    });
});
</script>

<script>
   document.addEventListener('DOMContentLoaded', function () {
    
    function filterRows(filter) {
        const rows = document.querySelectorAll('#attendanceTable tbody tr');
        rows.forEach(row => {
            const statusCell = row.querySelectorAll('td')[6]; 
            const status = statusCell.textContent.trim();
            if (filter === 'All' || status === filter) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    // Event listeners for filter options
    document.getElementById('filterAll').addEventListener('click', function () {
        filterRows('All');
    });

    document.getElementById('filterDraft').addEventListener('click', function () {
        filterRows('Draft');
    });

    document.getElementById('filterSave').addEventListener('click', function () {
        filterRows('Save');
    });
});
</script>



<script>
    function exportToExcel() {
        var table = document.querySelector('#attendanceTable');
        var ws = XLSX.utils.table_to_sheet(table);

        
        var range = XLSX.utils.decode_range(ws['!ref']);
        for (var C = range.s.c; C <= range.e.c; ++C) {
            var width = 20;
            ws['!cols'] = ws['!cols'] || [];
            ws['!cols'][C] = { wch: width };
        }

        var wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
        XLSX.writeFile(wb, 'DeliveryChallan.xlsx');
    }
</script>
    
</body>

{% endblock %}